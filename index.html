<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GPS 3D íŠ¸ë˜ì»¤ â€“ ë‹¨ê³„ë³„ ì£¼ì†Œ + ì§€ì˜¤íœìŠ¤</title>
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>
<style>
  :root{ --fx-color:#FF9800; --fx-ringW:10px; --fx-duration:1100ms; }
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Apple SD Gothic Neo,sans-serif;background:#0b1020}
  .topbar{position:fixed;left:0;right:0;top:0;z-index:10;background:rgba(255,255,255,.94);backdrop-filter:saturate(1.1) blur(8px);padding:10px 12px;border-bottom:1px solid #e6e6e6;display:grid;gap:8px}
  .toprow{display:grid;grid-template-columns: 1fr auto; gap:8px; align-items:center}
  .hstack{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .fieldrow{display:grid;grid-template-columns: repeat(5, minmax(120px,1fr)) auto; gap:8px}
  .chip{padding:6px 10px;border:1px solid #d0d0d0;border-radius:16px;background:#fff;display:flex;gap:6px;align-items:center}
  input[type="text"],input[type="number"],select{padding:8px 10px;border:1px solid #d0d0d0;border-radius:8px;width:100%}
  button{padding:8px 12px;border:0;border-radius:20px;cursor:pointer;font-weight:600}
  .btn-primary{background:#1976d2;color:#fff}.btn-secondary{background:#6c757d;color:#fff}.btn-ghost{background:#fff;border:1px solid #d0d0d0}
  #map{position:fixed;inset:96px 0 0 0}
  .panel{position:fixed;left:10px;right:10px;bottom:10px;z-index:9;background:rgba(255,255,255,.92);backdrop-filter: blur(8px);border-radius:14px;padding:10px 12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .kv{font-size:12px;color:#666}.v{font-weight:700;color:#222}.badge{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:700}
  .ok{background:#e8f5e9;color:#2e7d32}.warn{background:#fff8e1;color:#b26a00}.err{background:#ffebee;color:#c62828}
  #fx-overlay{position:fixed;inset:96px 0 0 0;pointer-events:none} #fx-ring{position:absolute;inset:0;border:var(--fx-ringW) solid var(--fx-color);border-radius:8px;opacity:0;transform:scale(.98)}
  .fx-cross #fx-ring{animation:fxPulse var(--fx-duration) ease-out}@keyframes fxPulse{0%{opacity:.0;transform:scale(.96)}10%{opacity:.9}60%{opacity:.35}100%{opacity:0;transform:scale(1.04)}}
  .shakeL{animation:shakeL 250ms linear}.shakeM{animation:shakeM 400ms linear}.shakeH{animation:shakeH 600ms linear}
  @keyframes shakeL{0%,100%{transform:translate(0,0)}25%{transform:translate(2px,0)}50%{transform:translate(-2px,0)}75%{transform:translate(1px,0)}}
  @keyframes shakeM{0%,100%{transform:translate(0,0)}20%{transform:translate(3px,0)}40%{transform:translate(-3px,0)}60%{transform:translate(2px,0)}80%{transform:translate(-2px,0)}}
  @keyframes shakeH{0%,100%{transform:translate(0,0)}15%{transform:translate(4px,0)}30%{transform:translate(-4px,0)}45%{transform:translate(3px,0)}60%{transform:translate(-3px,0)}75%{transform:translate(2px,0)}90%{transform:translate(-2px,0)}}
  .toast{position:fixed;left:50%;top:110px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;z-index:20;box-shadow:0 8px 24px rgba(0,0,0,.25);opacity:0;transition:opacity .2s, transform .2s}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
  <div class="topbar">
    <div class="toprow">
      <div class="hstack">
        <span class="badge ok" id="status">ëŒ€ê¸°</span>
        <label class="chip"><input id="optFollow" type="checkbox" checked> ë‚´ ìœ„ì¹˜ ë”°ë¼ê°€ê¸°</label>
        <label class="chip"><input id="optRotate" type="checkbox"> í—¤ë”© íšŒì „</label>
        <label class="chip">ê°•ë„
          <select id="intensity"><option value="L">L</option><option value="M" selected>M</option><option value="H">H</option></select>
        </label>
        <label class="chip"><input id="optPulse" type="checkbox" checked> í„ìŠ¤</label>
        <label class="chip"><input id="optShake" type="checkbox" checked> í”ë“¤ë¦¼</label>
        <label class="chip"><input id="optSound" type="checkbox" checked> ì‚¬ìš´ë“œ</label>
        <label class="chip">ë³¼ë¥¨ <input id="vol" type="range" min="0" max="100" value="70" style="width:120px"></label>
        <button id="enableAudio" class="btn-secondary">ğŸ”Š ì‚¬ìš´ë“œ í™œì„±í™”</button>
      </div>
      <div class="hstack">
        <button class="btn-primary" id="start" disabled>ì¶”ì  ì‹œì‘</button>
        <button class="btn-ghost" id="stop" disabled>ì¶”ì  ì¤‘ì§€</button>
      </div>
    </div>

    <!-- ë‹¨ê³„ë³„ ì£¼ì†Œ ì…ë ¥ -->
    <div class="fieldrow">
      <select id="country">
        <option value="Korea, Republic of" selected>ëŒ€í•œë¯¼êµ­</option>
        <option value="Japan">ì¼ë³¸</option>
        <option value="United States">ë¯¸êµ­</option>
        <option value="Germany">ë…ì¼</option>
        <option value="Italy">ì´íƒˆë¦¬ì•„</option>
      </select>
      <input id="postal" type="text" placeholder="ìš°í¸ë²ˆí˜¸ (ì„ íƒ)" />
      <input id="city"   type="text" placeholder="ë„ì‹œ (ì˜ˆ: ì„œìš¸íŠ¹ë³„ì‹œ)" />
      <input id="street" type="text" placeholder="ë„ë¡œ/ë²ˆì§€ (ì˜ˆ: ì„¸ì¢…ëŒ€ë¡œ 110)" />
      <input id="radius" type="number" min="10" step="10" value="150" title="ë°˜ê²½(m)" />
      <button class="btn-ghost" id="setZone">ì˜ì—­ ì„¤ì •</button>
    </div>
  </div>

  <div id="map"></div>
  <div id="fx-overlay"><div id="fx-ring"></div></div>

  <div class="panel">
    <span class="kv">ìœ„ë„ <span class="v" id="lat">--</span></span>
    <span class="kv">ê²½ë„ <span class="v" id="lng">--</span></span>
    <span class="kv">ì •í™•ë„ <span class="v" id="acc">-- m</span></span>
    <span class="kv">ì†ë„ <span class="v" id="spd">-- m/s</span></span>
    <span class="kv">ì§€ì˜¤íœìŠ¤ <span class="v" id="zoneState">ë¯¸ì„¤ì •</span></span>
  </div>

  <div class="toast" id="toast">ì™„ë£Œ</div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
/* ===== 1) ì—¬ê¸°ì—ë§Œ ë³¸ì¸ í‚¤ ì…ë ¥ ===== */
const MAPTILER_KEY = '1GIth02fVnNfY2y7CFck';   // â† ë°œê¸‰ë°›ì€ í‚¤ë¡œ ë°”ê¾¸ì„¸ìš” (ë”°ì˜´í‘œ ìœ ì§€)
/* í‚¤ ì¡´ì¬ ì—¬ë¶€ íŒë‹¨(ì´ ì¤„ì€ ì ˆëŒ€ ë°”ê¾¸ì§€ ë§ˆì„¸ìš”) */
const HAS_KEY = Boolean(MAPTILER_KEY && MAPTILER_KEY !== 'YOUR_MAPTILER_KEY_HERE');

/* ===== ì§€ë„ ìƒì„±: í‚¤ ì—†ìœ¼ë©´ OSM ë˜ìŠ¤í„° í´ë°± ===== */
function createMap() {
  const style = HAS_KEY
    ? `https://api.maptiler.com/maps/streets-v2/style.json?key=${MAPTILER_KEY}`
    : { version: 8, sources: {
          osm: { type:'raster', tiles:['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, attribution:'Â© OpenStreetMap' }
        }, layers:[{ id:'osm', type:'raster', source:'osm' }] };
  const map = new maplibregl.Map({
    container: 'map', style, center:[126.9780,37.5665], zoom:13, pitch: HAS_KEY?60:0, bearing:-20
  });
  map.addControl(new maplibregl.NavigationControl({ visualizePitch: HAS_KEY }), 'top-right');
  return map;
}

/* ===== ì§€ì˜¤ì½”ë”© (ë°˜ë“œì‹œ ?key= í¬í•¨) ===== */
async function geocodeAddress(q){
  if (!HAS_KEY) throw new Error('ì§€ì˜¤ì½”ë”©ì€ MapTiler í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
  const url = `https://api.maptiler.com/geocoding/${encodeURIComponent(q)}.json?limit=1&key=${MAPTILER_KEY}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨ (HTTP ${res.status})`);
  const j = await res.json();
  if (!j.features?.length) throw new Error('ì£¼ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
  const [lng, lat] = j.features[0].center;
  return {lat, lng, label: j.features[0].place_name || q};
}

/* ===== ìœ í‹¸ ===== */
const R = 6371000;
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const toast=(m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); };
function haversine(a,b){ const toRad=d=>d*Math.PI/180; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng); const A=toRad(a.lat), B=toRad(b.lat); const h=Math.sin(dLat/2)**2+Math.cos(A)*Math.cos(B)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }

/* ===== ì•± ===== */
class App {
  constructor(){
    this.map=createMap();
    this.marker=new maplibregl.Marker({color:'#e53935'});
    this.path=[]; this.geoFence=null; this.inFence=null; this.watchId=null;
    this.lastPos=null; this.lastTime=0; this.audio={ctx:null,gain:null};
    this.bindUI();
  }
  bindUI(){
    setStatus('ëŒ€ê¸°','ok');
    document.getElementById('setZone').onclick=()=>this.onSetZone();
    document.getElementById('start').onclick=()=>this.start();
    document.getElementById('stop').onclick=()=>this.stop();
    document.getElementById('enableAudio').onclick=()=>this.enableAudio();
  }
  buildAddressLine(){
    const country=document.getElementById('country').value.trim();
    const postal=document.getElementById('postal').value.trim();
    const city=document.getElementById('city').value.trim();
    const street=document.getElementById('street').value.trim();
    const parts=[]; if(street)parts.push(street); if(city)parts.push(city); if(postal)parts.push(postal); if(country)parts.push(country);
    return parts.join(', ');
  }
  async onSetZone(){
    try{
      const r=parseFloat(document.getElementById('radius').value)||150;
      if (r<=0) throw new Error('ë°˜ê²½(m)ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.');
      const q=this.buildAddressLine();
      if (!q) throw new Error('êµ­ê°€/ë„ì‹œ/ë„ë¡œ ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”.');
      const g=await geocodeAddress(q);         // â† í‚¤ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì •í™•íˆ ì—ëŸ¬ í‘œì‹œ
      this.setGeofence({lat:g.lat,lng:g.lng}, r);
      document.getElementById('zoneState').textContent=`ì„¤ì •ë¨ (${Math.round(r)} m)`;
      document.getElementById('start').disabled=false;
      toast('ì˜ì—­ì´ ì˜ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
      setStatus('ì§€ì˜¤íœìŠ¤ ì„¤ì • ì™„ë£Œ','ok');
    }catch(e){ setStatus(e.message,'warn'); toast(e.message); }
  }
  setGeofence(center,radius){
    this.geoFence={center,radius};
    const idS='fence-src', idF='fence-fill', idL='fence-line';
    if(this.map.getSource(idS)){ if(this.map.getLayer(idF))this.map.removeLayer(idF); if(this.map.getLayer(idL))this.map.removeLayer(idL); this.map.removeSource(idS); }
    const gj=this.circle(center,radius,128);
    this.map.addSource(idS,{type:'geojson',data:gj});
    this.map.addLayer({id:idF,type:'fill',source:idS,paint:{'fill-color':'#ff9800','fill-opacity':0.08}});
    this.map.addLayer({id:idL,type:'line',source:idS,paint:{'line-color':'#ff9800','line-width':2,'line-opacity':0.7}});
    this.map.easeTo({center:[center.lng,center.lat],zoom:15,duration:600,pitch:HAS_KEY?60:0});
  }
  circle(c,r,steps=64){ const pts=[]; for(let i=0;i<=steps;i++){const th=(i/steps)*2*Math.PI,dx=(r/R)*Math.cos(th),dy=(r/R)*Math.sin(th); const lat=c.lat+(dy*180/Math.PI); const lng=c.lng+(dx*180/Math.PI)/Math.cos(c.lat*Math.PI/180); pts.push([lng,lat]); } return {type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'Polygon',coordinates:[pts]}}]}; }
  start(){
    if(!this.geoFence){ toast('ë¨¼ì € ì£¼ì†Œ/ë°˜ê²½ìœ¼ë¡œ ì˜ì—­ì„ ì„¤ì •í•˜ì„¸ìš”'); setStatus('ì§€ì˜¤íœìŠ¤ ë¯¸ì„¤ì •','warn'); return; }
    if(!navigator.geolocation){ setStatus('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤','err'); return; }
    if(this.watchId) return;
    this.watchId=navigator.geolocation.watchPosition(p=>this.onPos(p),e=>this.onErr(e),{enableHighAccuracy:true,timeout:10000,maximumAge:0});
    document.getElementById('start').disabled=true; document.getElementById('stop').disabled=false; setStatus('ì¶”ì  ì‹œì‘','ok');
  }
  stop(){ if(this.watchId){navigator.geolocation.clearWatch(this.watchId);this.watchId=null;} document.getElementById('start').disabled=false; document.getElementById('stop').disabled=true; setStatus('ì¶”ì  ì¤‘ì§€','warn'); }
  onErr(e){ const m=(e.code===1)?'ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€':(e.code===2)?'ìœ„ì¹˜ ë¶ˆê°€':(e.code===3)?'ì‹œê°„ ì´ˆê³¼':'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'; setStatus(m,'err'); toast(m); }
  onPos(p){
    const c=p.coords, now=p.timestamp||Date.now(), cur={lat:c.latitude,lng:c.longitude};
    const spd=this.estimateSpeed(this.lastPos,this.lastTime,cur,now); const hdg=(typeof c.heading==='number'&&!Number.isNaN(c.heading))?c.heading:null;
    this.lastPos=cur; this.lastTime=now;
    this.marker.setLngLat([cur.lng,cur.lat]).addTo(this.map); this.path.push([cur.lng,cur.lat]); this.updatePath();
    document.getElementById('lat').textContent=cur.lat.toFixed(6); document.getElementById('lng').textContent=cur.lng.toFixed(6);
    document.getElementById('acc').textContent=Math.round(c.accuracy||0)+' m'; document.getElementById('spd').textContent=(spd?spd.toFixed(2):'0')+' m/s';
    setStatus('ì¶”ì  ì¤‘','ok');
    const follow=document.getElementById('optFollow').checked, rotate=document.getElementById('optRotate').checked;
    if(follow){ const z=clamp(19-clamp((spd||0)/5,0,2),16,19); const brg=rotate&&hdg!=null?hdg:this.map.getBearing(); this.map.easeTo({center:[cur.lng,cur.lat],zoom:z,pitch:HAS_KEY?70:0,bearing:brg,duration:600,easing:t=>t*(2-t)});}
    this.checkFence(cur);
  }
  estimateSpeed(prev,pt,cur,ct){ if(!prev||!pt) return 0; const dt=(ct-pt)/1000; if(dt<=0) return 0; return haversine(prev,cur)/dt; }
  updatePath(){ const id='path-src', idL='path-line'; if(!this.map.getSource(id)){ this.map.addSource(id,{type:'geojson',data:{type:'FeatureCollection',features:[]}}); this.map.addLayer({id:idL,type:'line',source:id,paint:{'line-color':'#FF5722','line-width':3,'line-opacity':0.75}});} this.map.getSource(id).setData({type:'FeatureCollection',features:[{type:'Feature',geometry:{type:'LineString',coordinates:this.path}}]}); }
  checkFence(cur){
    if(!this.geoFence) return;
    const d=haversine(cur,this.geoFence.center), insideNow=d<=this.geoFence.radius, buf=this.geoFence.radius*0.025;
    if(this.inFence===null){ this.inFence=insideNow; document.getElementById('zoneState').textContent = insideNow?'ì˜ì—­ ë‚´':'ì˜ì—­ ë°–'; return; }
    if(this.inFence && d>this.geoFence.radius+buf){ this.inFence=false; this.fx(false); }
    else if(!this.inFence && d<this.geoFence.radius-buf){ this.inFence=true; this.fx(true); }
  }
  fx(inside){
    const fx=document.getElementById('fx-overlay'), ring=document.getElementById('fx-ring'), usePulse=document.getElementById('optPulse').checked, useShake=document.getElementById('optShake').checked, lvl=document.getElementById('intensity').value;
    const color=inside?'#FF9800':'#ADD8E6'; document.documentElement.style.setProperty('--fx-color',color);
    const ringW=lvl==='L'?'6px':lvl==='H'?'12px':'9px', dur=lvl==='L'?800:lvl==='H'?1400:1100; document.documentElement.style.setProperty('--fx-ringW',ringW); document.documentElement.style.setProperty('--fx-duration',dur+'ms');
    fx.classList.remove('fx-cross'); ring.classList.remove('shakeL','shakeM','shakeH'); void fx.offsetWidth; if(usePulse) fx.classList.add('fx-cross'); if(useShake) ring.classList.add(lvl==='L'?'shakeL':lvl==='H'?'shakeH':'shakeM');
    this.beep(inside); document.getElementById('zoneState').textContent=inside?'ì§„ì…(ì˜¤ë Œì§€)':'ì´íƒˆ(ì—°ì²­ìƒ‰)';
  }
  enableAudio(){ try{ if(this.audio.ctx){ setStatus('ì‚¬ìš´ë“œ ì¤€ë¹„ ì™„ë£Œ','ok'); return; } const C=window.AudioContext||window.webkitAudioContext; const ctx=new C(); const gain=ctx.createGain(); gain.connect(ctx.destination); gain.gain.value=(document.getElementById('vol').value|0)/100; this.audio={ctx,gain}; if(ctx.state==='suspended') ctx.resume(); setStatus('ì‚¬ìš´ë“œ ì¤€ë¹„ ì™„ë£Œ','ok'); }catch(e){ setStatus('ì˜¤ë””ì˜¤ ì´ˆê¸°í™” ì‹¤íŒ¨','err'); } }
  beep(inside){ if(!document.getElementById('optSound').checked) return; if(!this.audio.ctx) return; const {ctx,gain}=this.audio; const v=(document.getElementById('vol').value|0)/100; const o=ctx.createOscillator(), g=ctx.createGain(); g.gain.value=0.0001; o.connect(g); g.connect(gain);
    if(inside){ o.type='triangle'; o.frequency.setValueAtTime(1046,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.45*v,ctx.currentTime+0.25); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.9); o.start(); o.stop(ctx.currentTime+0.92);}
    else{ o.type='square'; o.frequency.setValueAtTime(392,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.35*v,ctx.currentTime+0.15); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.45); o.start(); o.stop(ctx.currentTime+0.47);}
  }
}
function setStatus(text,kind){ const el=document.getElementById('status'); el.textContent=text; el.className='badge ' + (kind||'ok'); }

const app=new App();

/* ë¯¸ë‹ˆ í…ŒìŠ¤íŠ¸ */
(function(){ console.assert(Math.abs(haversine({lat:0,lng:0},{lat:0,lng:1})-111319)<250,'ê²½ë„1ë„â‰ˆ111.3km'); })();
</script>
</body>
</html>
